<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É™„Ç¢„É´„Çø„Ç§„É†„Ç∑„Éï„ÉàÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† (SupabaseÁâà)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* „Ç´„Çπ„Çø„É†„Éï„Ç©„É≥„ÉàË®≠ÂÆö */
        :root {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <!-- React, ReactDOM, Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        const supabaseUrl = 'https://nfsfujgqcczwkrycoiph.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc2Z1amdxY2N6d2tyeWNvaXBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNzc0NTksImV4cCI6MjA3NTY1MzQ1OX0.qvOV8eN7dHnwsVWIwp47LZwIYSuNPJSqhAGn3VNrogE';

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ (CanvasÁí∞Â¢É„Åã„ÇâÊ≥®ÂÖ•„Åï„Çå„Çã„Åì„Å®„ÇíÊÉ≥ÂÆö)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÂàùÊúüÂåñ„Å®„Ç∞„É≠„Éº„Éê„É´ÂÖ¨Èñã
        if (supabaseUrl !== 'YOUR_SUPABASE_URL' && supabaseAnonKey !== 'YOUR_SUPABASE_ANON_KEY') {
            window.supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
        }

        // „Ç∞„É≠„Éº„Éê„É´ÂÆöÊï∞„ÇíÂÖ¨Èñã
        window.AppConfig = {
            appId,
            supabaseUrl,
            supabaseAnonKey
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const rootElement = document.getElementById('root');
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Åã„ÇâÂøÖË¶Å„Å™„Ç§„É≥„Çπ„Çø„É≥„Çπ„Å®Ë®≠ÂÆö„ÇíÂèñÂæó
        const { appId, supabaseUrl, supabaseAnonKey } = window.AppConfig || {};
        const supabaseClient = window.supabase;

        // UI„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà (Spinner, Modal)
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center p-4">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                <span className="ml-3 text-gray-600">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
            </div>
        );

        const Modal = ({ title, message, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 className="text-xl font-bold text-red-600 mb-4 border-b pb-2">{title}</h3>
                    <p className="text-gray-700 mb-6">{message}</p>
                    <button
                        onClick={onClose}
                        className="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150"
                    >
                        Èñâ„Åò„Çã
                    </button>
                </div>
            </div>
        );

        // „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
        function App() {
            // Áä∂ÊÖãÁÆ°ÁêÜ
            const [shifts, setShifts] = useState([]);
            const [newShift, setNewShift] = useState({
                name: '',
                date: '',
                start: '09:00',
                end: '17:00'
            });
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [editingShift, setEditingShift] = useState(null);

            // 1. Supabase„ÅÆÂàùÊúüÂåñ„ÉÅ„Çß„ÉÉ„ÇØ
            useEffect(() => {
                if (!supabaseClient) {
                    console.error("Supabase client is not initialized.");
                    setError({ title: "Ë®≠ÂÆö„Ç®„É©„Éº", message: "Supabase„ÅÆURL„Å®anon„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç≥„Éº„ÉâÂÜÖ„ÅÆ'YOUR_SUPABASE_URL'„Å®'YOUR_SUPABASE_ANON_KEY'„ÇíÊõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" });
                }
                setIsLoading(false);
            }, []);

            // 2. „É™„Ç¢„É´„Çø„Ç§„É†„Åß„ÅÆ„Ç∑„Éï„Éà„Éá„Éº„ÇøÂèñÂæó
            useEffect(() => {
                if (!supabaseClient) return;

                const fetchShifts = async () => {
                    const { data, error } = await supabaseClient
                        .from('shifts')
                        .select('*')
                        .eq('app_id', appId)
                        .order('date', { ascending: true })
                        .order('start', { ascending: true });

                    if (error) {
                        console.error("Error fetching shifts:", error);
                        setError({ title: "„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº", message: "„Ç∑„Éï„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ" });
                    } else {
                        setShifts(data);
                    }
                };

                fetchShifts();

                const channel = supabaseClient
                    .channel('public:shifts')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'shifts' }, payload => {
                        console.log('Change received!', payload);
                        fetchShifts(); // „Éá„Éº„Çø„ÅåÂ§âÊõ¥„Åï„Çå„Åü„ÇâÂÜçÂèñÂæó
                    })
                    .subscribe();

                // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñ¢Êï∞
                return () => {
                    supabaseClient.removeChannel(channel);
                };
            }, [supabaseClient]);

            // „Ç∑„Éï„ÉàÁ∑®ÈõÜÈñãÂßã„Éè„É≥„Éâ„É©
            const handleEditClick = (shift) => {
                setNewShift({
                    name: shift.name,
                    date: shift.date,
                    start: shift.start,
                    end: shift.end
                });
                setEditingShift(shift);
            };

            // Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´„Éè„É≥„Éâ„É©
            const handleCancelEdit = () => {
                setNewShift({
                    name: '',
                    date: '',
                    start: '09:00',
                    end: '17:00'
                });
                setEditingShift(null);
            };

            // ÂÖ•ÂäõÂÄ§Â§âÊõ¥„Éè„É≥„Éâ„É©
            const handleChange = (e) => {
                const { name, value } = e.target;
                setNewShift(prev => ({ ...prev, [name]: value }));
            };

            // „Ç∑„Éï„ÉàËøΩÂä†/Êõ¥Êñ∞„Éè„É≥„Éâ„É©
            const handleSubmitShift = async (e) => {
                e.preventDefault();

                // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                if (!newShift.name || !newShift.date || !newShift.start || !newShift.end) {
                    setError({ title: "ÂÖ•ÂäõÊºè„Çå", message: "Ê∞èÂêç„ÄÅÊó•‰ªò„ÄÅÂã§ÂãôÈñãÂßã„ÄÅÂã§ÂãôÁµÇ‰∫Ü„ÅØ„Åô„Åπ„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" });
                    return;
                }

                if (newShift.start >= newShift.end) {
                    setError({ title: "ÊôÇÈñì„Ç®„É©„Éº", message: "Âã§ÂãôÈñãÂßãÊôÇÈñì„ÅØÂã§ÂãôÁµÇ‰∫ÜÊôÇÈñì„Çà„Çä„ÇÇÂâç„Å´Ë®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" });
                    return;
                }

                if (!supabaseClient) {
                    setError({ title: "„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº", message: "„Éá„Éº„Çø„Éô„Éº„Çπ„ÅåÊ∫ñÂÇô„Åß„Åç„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ" });
                    return;
                }

                try {
                    if (editingShift) {
                        // Êõ¥Êñ∞Âá¶ÁêÜ
                        const { error } = await supabaseClient
                            .from('shifts')
                            .update({ ...newShift, app_id: appId })
                            .match({ 
                                app_id: appId,
                                name: editingShift.name,
                                date: editingShift.date,
                                start: editingShift.start,
                                end: editingShift.end
                             });

                        if (error) {
                            throw error;
                        }
                        setEditingShift(null); // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
                    } else {
                        // ËøΩÂä†Âá¶ÁêÜ
                        const { error } = await supabaseClient
                            .from('shifts')
                            .insert([
                                { ...newShift, app_id: appId }
                            ]);

                        if (error) {
                            throw error;
                        }
                    }

                    // ÊàêÂäüÂæå„ÄÅ„Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                    setNewShift({
                        name: '',
                        date: '',
                        start: '09:00',
                        end: '17:00'
                    });
                    setEditingShift(null);

                } catch (error) {
                    console.error("Error adding/updating document: ", error);
                    setError({ title: "Êìç‰ΩúÂ§±Êïó", message: `„Ç∑„Éï„Éà„ÅÆ${editingShift ? 'Êõ¥Êñ∞' : 'ÁôªÈå≤'}‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}` });
                }
            };

            // „Ç∑„Éï„ÉàÂâäÈô§„Éè„É≥„Éâ„É©
            const handleDeleteShift = async (shift) => {
                if (!supabaseClient) {
                    setError({ title: "„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº", message: "„Éá„Éº„Çø„Éô„Éº„Çπ„ÅåÊ∫ñÂÇô„Åß„Åç„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ" });
                    return;
                }

                // ÂâäÈô§Ââç„Å´Á¢∫Ë™ç
                if (window.confirm("„Åì„ÅÆ„Ç∑„Éï„Éà„ÇíÊú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                    try {
                        const { error } = await supabaseClient
                            .from('shifts')
                            .delete()
                            .match({ 
                                app_id: appId,
                                name: shift.name,
                                date: shift.date,
                                start: shift.start,
                                end: shift.end
                            });

                        if (error) {
                            throw error;
                        }
                        // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞„Å´‰ªª„Åõ„Çã„ÅÆ„Åß„ÄÅ„É≠„Éº„Ç´„É´„Çπ„ÉÜ„Éº„Éà„ÅÆÊõ¥Êñ∞„ÅØ‰∏çË¶Å
                    } catch (error) {
                        console.error("Error deleting shift: ", error);
                        setError({ title: "ÂâäÈô§Â§±Êïó", message: `„Ç∑„Éï„Éà„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}` });
                    }
                }
            };

            // Êó•‰ªòÊñáÂ≠óÂàó„Çí„ÄåMÊúàDÊó•(ÊõúÊó•)„ÄçÂΩ¢Âºè„Å´„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Åô„ÇãÈñ¢Êï∞
            const formatDate = (dateString) => {
                try {
                    const date = new Date(dateString);
                    if (isNaN(date)) return dateString;
                    
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const dayOfWeek = date.toLocaleDateString('ja-JP', { weekday: 'short' });
                    return `${month}Êúà${day}Êó•(${dayOfWeek})`;
                } catch (e) {
                    return dateString;
                }
            };

            // Êó•‰ªò„Åß„Ç∑„Éï„Éà„Çí„Ç∞„É´„Éº„ÉóÂåñ„Åô„Çã
            const groupedShifts = shifts.reduce((acc, shift) => {
                const date = shift.date;
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(shift);
                return acc;
            }, {});

            // „É°„Ç§„É≥UI„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            if (isLoading && !error) {
                return <LoadingSpinner />;
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-inter">
                    {/* „Ç®„É©„Éº„É¢„Éº„ÉÄ„É´ */}
                    {error && <Modal title={error.title} message={error.message} onClose={() => setError(null)} />}

                    <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-8">
                        <header className="mb-8 border-b pb-4">
                            <h1 className="text-3xl font-extrabold text-indigo-700">üóì „É™„Ç¢„É´„Çø„Ç§„É†„Ç∑„Éï„ÉàÁÆ°ÁêÜ (SupabaseÁâà)</h1>
                            <p className="text-sm text-gray-500 mt-1">
                                „Ç¢„Éó„É™ID: <span className="font-mono text-xs bg-gray-100 px-1 rounded">{appId}</span>
                            </p>
                        </header>

                        {/* 1. „Ç∑„Éï„ÉàÂÖ•Âäõ„Éï„Ç©„Éº„É† */}
                        <section className="mb-10 p-6 bg-indigo-50 rounded-xl shadow-inner">
                            <h2 className="text-xl font-bold text-indigo-600 mb-4">Êñ∞„Åó„ÅÑ„Ç∑„Éï„Éà„ÅÆÁôªÈå≤</h2>
                            <form onSubmit={handleSubmitShift} className="grid grid-cols-2 gap-4 sm:grid-cols-5">
                                <div className="col-span-2 sm:col-span-1">
                                    <label htmlFor="name" className="block text-sm font-medium text-gray-700">Ê∞èÂêç</label>
                                    <input
                                        id="name"
                                        name="name"
                                        type="text"
                                        value={newShift.name}
                                        onChange={handleChange}
                                        placeholder="‰æã: Â±±Áî∞Â§™ÈÉé"
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500"
                                        required
                                    />
                                </div>
                                <div className="col-span-2 sm:col-span-1">
                                    <label htmlFor="date" className="block text-sm font-medium text-gray-700">Êó•‰ªò</label>
                                    <input
                                        id="date"
                                        name="date"
                                        type="date"
                                        value={newShift.date}
                                        onChange={handleChange}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500"
                                        required
                                    />
                                </div>
                                <div className="col-span-1">
                                    <label htmlFor="start" className="block text-sm font-medium text-gray-700">Âã§ÂãôÈñãÂßã</label>
                                    <input
                                        id="start"
                                        name="start"
                                        type="time"
                                        value={newShift.start}
                                        onChange={handleChange}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500"
                                        required
                                    />
                                </div>
                                <div className="col-span-1">
                                    <label htmlFor="end" className="block text-sm font-medium text-gray-700">Âã§ÂãôÁµÇ‰∫Ü</label>
                                    <input
                                        id="end"
                                        name="end"
                                        type="time"
                                        value={newShift.end}
                                        onChange={handleChange}
                                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500"
                                        required
                                    />
                                </div>
                                <div className="col-span-2 sm:col-span-1 self-end flex space-x-2">
                                    <button
                                        type="submit"
                                        className="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-105"
                                        disabled={!supabaseClient}
                                    >
                                        {editingShift ? '‚úì Êõ¥Êñ∞' : 'Ôºã ËøΩÂä†'}
                                    </button>
                                    {editingShift && (
                                        <button
                                            type="button"
                                            onClick={handleCancelEdit}
                                            className="w-full bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 transition duration-150"
                                        >
                                            „Ç≠„É£„É≥„Çª„É´
                                        </button>
                                    )}
                                </div>
                            </form>
                        </section>

                        {/* 2. „Ç∑„Éï„Éà‰∏ÄË¶ßË°®Á§∫ */}
                        <section>
                            <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">‰ªäÂæå„ÅÆ„Ç∑„Éï„Éà‰∏ÄË¶ßÔºàÂÖ®{shifts.length}‰ª∂Ôºâ</h2>
                            
                            {!supabaseClient ? (
                                <p className="text-red-500 p-4 bg-red-100 rounded-lg text-center">
                                    Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
                                </p>
                            ) : shifts.length === 0 ? (
                                <p className="text-gray-500 p-4 bg-gray-100 rounded-lg text-center">
                                    „Åæ„Å†„Ç∑„Éï„Éà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ‰∏ä„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                                </p>
                            ) : (
                                <div className="space-y-8">
                                    {Object.entries(groupedShifts).map(([date, shiftsOnDate]) => (
                                        <div key={date}>
                                            <h3 className="text-lg font-bold text-gray-700 mb-3 bg-gray-100 p-2 rounded-lg">
                                                {formatDate(date)}
                                            </h3>
                                            <div className="overflow-x-auto rounded-lg shadow-md">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-200">
                                                        <tr>
                                                            <th className="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ê∞èÂêç</th>
                                                            <th className="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ÈñãÂßã</th>
                                                            <th className="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ÁµÇ‰∫Ü</th>
                                                            <th className="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden sm:table-cell">Âã§ÂãôÊôÇÈñì</th>
                                                            <th className="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Êìç‰Ωú</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-100">
                                                        {shiftsOnDate.map((shift, index) => {
                                                            const startMinutes = parseInt(shift.start.split(':')[0]) * 60 + parseInt(shift.start.split(':')[1]);
                                                            const endMinutes = parseInt(shift.end.split(':')[0]) * 60 + parseInt(shift.end.split(':')[1]);
                                                            const durationMinutes = endMinutes > startMinutes ? endMinutes - startMinutes : (24 * 60 - startMinutes) + endMinutes;
                                                            const durationHours = (durationMinutes / 60).toFixed(1);

                                                            return (
                                                                <tr key={index} className={index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100'}>
                                                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{shift.name}</td>
                                                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-indigo-600 font-semibold">{shift.start}</td>
                                                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-indigo-600 font-semibold">{shift.end}</td>
                                                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">{durationHours} ÊôÇÈñì</td>
                                                                    <td className="px-4 py-3 whitespace-nowrap text-sm">
                                                                        <button
                                                                            onClick={() => handleEditClick(shift)}
                                                                            className="bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg shadow-md hover:bg-blue-600 transition duration-150 mr-2"
                                                                        >
                                                                            Á∑®ÈõÜ
                                                                        </button>
                                                                        <button
                                                                            onClick={() => handleDeleteShift(shift)}
                                                                            className="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg shadow-md hover:bg-red-600 transition duration-150"
                                                                        >
                                                                            ÂâäÈô§
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>
                    </div>
                </div>
            );

        }
        
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíDOM„Å´„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);

    </script>
</body>
</html>
